{"remainingRequest":"/home/d/github/box-im/im-web/node_modules/vue-loader/lib/index.js??vue-loader-options!/home/d/github/box-im/im-web/src/components/chat/ChatInput.vue?vue&type=style&index=0&id=18b5dc6a&lang=scss","dependencies":[{"path":"/home/d/github/box-im/im-web/src/components/chat/ChatInput.vue","mtime":1727013808920},{"path":"/home/d/github/box-im/im-web/node_modules/css-loader/dist/cjs.js","mtime":1727014164027},{"path":"/home/d/github/box-im/im-web/node_modules/vue-loader/lib/loaders/stylePostLoader.js","mtime":1727014163855},{"path":"/home/d/github/box-im/im-web/node_modules/postcss-loader/src/index.js","mtime":1727014163867},{"path":"/home/d/github/box-im/im-web/node_modules/sass-loader/dist/cjs.js","mtime":1727014166331},{"path":"/home/d/github/box-im/im-web/node_modules/cache-loader/dist/cjs.js","mtime":1727014166207},{"path":"/home/d/github/box-im/im-web/node_modules/vue-loader/lib/index.js","mtime":1727014163811}],"contextDependencies":[],"result":[{"type":"Buffer","data":"base64:Ci5jaGF0LWlucHV0LWFyZWEgewoJd2lkdGg6IDEwMCU7CgloZWlnaHQ6IDEwMCU7Cglwb3NpdGlvbjogcmVsYXRpdmU7CgoJLmVkaXQtY2hhdC1jb250YWluZXIgewoJCXBvc2l0aW9uOiBhYnNvbHV0ZTsKCQl0b3A6IDA7CgkJbGVmdDogMDsKCQlyaWdodDogMDsKCQlib3R0b206IDA7CgkJYm9yZGVyOiAxcHggc29saWQgI2MzYzNjMzsKCQlvdXRsaW5lOiBub25lOwoJCXBhZGRpbmc6IDVweDsKCQlsaW5lLWhlaWdodDogMzBweDsKCQlmb250LXNpemU6IDE2cHg7CgkJdGV4dC1hbGlnbjogbGVmdDsKCQlvdmVyZmxvdy15OiBzY3JvbGw7CgoJCS8vIOWNleeLrOS4gOihjOaXtu+8jOaXoOazleWcqOWJjemdoui+k+WFpeeahGJ1ZwoJCT5kaXY6YmVmb3JlIHsKCQkJY29udGVudDogIlwwMGEwIjsKCQkJZm9udC1zaXplOiAxNHB4OwoJCQlwb3NpdGlvbjogYWJzb2x1dGU7CgkJCXRvcDogMDsKCQkJbGVmdDogMDsKCQl9CgoJCS5jaGF0LWltYWdlIHsKCQkJZGlzcGxheTogYmxvY2s7CgkJCW1heC13aWR0aDogMjAwcHg7CgkJCW1heC1oZWlnaHQ6IDEwMHB4OwoJCQlib3JkZXI6IDFweCBzb2xpZCAjZTZlNmU2OwoJCQljdXJzb3I6IHBvaW50ZXI7CgkJfQoKCQkuY2hhdC1lbW9qaSB7CgkJCXdpZHRoOiAzMHB4OwoJCQloZWlnaHQ6IDMwcHg7CgkJCXZlcnRpY2FsLWFsaWduOiB0b3A7CgkJCWN1cnNvcjogcG9pbnRlcjsKCQl9CgoJCS5jaGF0LWZpbGUtY29udGFpbmVyIHsKCQkJbWF4LXdpZHRoOiA2NSU7CgkJCXBhZGRpbmc6IDEwcHg7CgkJCWJvcmRlcjogMnB4IHNvbGlkICM1ODdmZjA7CgkJCWRpc3BsYXk6IGZsZXg7CgkJCWJhY2tncm91bmQ6ICNlZWVDOwoJCQlib3JkZXItcmFkaXVzOiAxMHB4OwoKCQkJLmZpbGUtcG9zaXRpb24tbGVmdCB7CgkJCQlkaXNwbGF5OiBmbGV4OwoJCQkJd2lkdGg6IDgwcHg7CgkJCQlqdXN0aWZ5LWNvbnRlbnQ6IGNlbnRlcjsKCQkJCWFsaWduLWl0ZW1zOiBjZW50ZXI7CgoJCQkJLmVsLWljb24tZG9jdW1lbnQgewoJCQkJCWZvbnQtc2l6ZTogNDBweDsKCQkJCQl0ZXh0LWFsaWduOiBjZW50ZXI7CgkJCQkJY29sb3I6ICNkNDJlMDc7CgkJCQl9CgkJCX0KCgkJCS5maWxlLXBvc2l0aW9uLXJpZ2h0IHsKCQkJCWZsZXg6IDE7CgoJCQkJLmZpbGUtbmFtZSB7CgkJCQkJZm9udC1zaXplOiAxNnB4OwoJCQkJCWZvbnQtd2VpZ2h0OiA2MDA7CgkJCQkJY29sb3I6ICM2NmIxZmY7CgkJCQl9CgoJCQkJLmZpbGUtc2l6ZSB7CgkJCQkJZm9udC1zaXplOiAxNHB4OwoJCQkJCWZvbnQtd2VpZ2h0OiA2MDA7CgkJCQkJY29sb3I6IGJsYWNrOwoJCQkJfQoJCQl9CgkJfQoKCQkuY2hhdC1hdC11c2VyIHsKCQkJY29sb3I6ICMwMGY7CgkJCWZvbnQtd2VpZ2h0OiA2MDA7CgoJCQlib3JkZXItcmFkaXVzOiAzcHg7CgkJfQoJfQoKCS5lZGl0LWNoYXQtY29udGFpbmVyPmRpdjpudGgtb2YtdHlwZSgxKTphZnRlciB7CgkJY29udGVudDogJ+ivt+i+k+WFpea2iOaBr++8iOaMiUN0cmwrRW50ZXLplK7mjaLooYzvvIknOwoJCWNvbG9yOiBncmF5OwoJfQoKCS5lZGl0LWNoYXQtY29udGFpbmVyLm5vdC1lbXB0eT5kaXY6bnRoLW9mLXR5cGUoMSk6YWZ0ZXIgewoJCWNvbnRlbnQ6IG5vbmU7Cgl9Cgp9Cg=="},{"version":3,"sources":["ChatInput.vue"],"names":[],"mappings":";AA2jBA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA","file":"ChatInput.vue","sourceRoot":"src/components/chat","sourcesContent":["<template>\n\t<div class=\"chat-input-area\">\n\t\t<div :class=\"['edit-chat-container',isEmpty?'':'not-empty']\" contenteditable=\"true\" @paste.prevent=\"onPaste\"\n\t\t\t@keydown=\"onKeydown\" @compositionstart=\"compositionFlag=true\" @compositionend=\"onCompositionEnd\"\n\t\t\t@input=\"onEditorInput\" @mousedown=\"onMousedown\" ref=\"content\" @blur=\"onBlur\">\n\t\t</div>\n\t\t<chat-at-box @select=\"onAtSelect\" :search-text=\"atSearchText\" ref=\"atBox\" :ownerId=\"ownerId\"\n\t\t\t:members=\"groupMembers\"></chat-at-box>\n\t</div>\n</template>\n\n<script>\n\timport ChatAtBox from \"./ChatAtBox\";\n\n\texport default {\n\t\tname: \"ChatInput\",\n\t\tcomponents: { ChatAtBox },\n\t\tprops: {\n\t\t\townerId: {\n\t\t\t\ttype: Number,\n\t\t\t},\n\t\t\tgroupMembers: {\n\t\t\t\ttype: Array,\n\t\t\t},\n\t\t},\n\t\tdata() {\n\t\t\treturn {\n\t\t\t\timageList: [],\n\t\t\t\tfileList: [],\n\t\t\t\tcurrentId: 0,\n\t\t\t\tatSearchText: null,\n\t\t\t\tcompositionFlag: false,\n\t\t\t\tatIng: false,\n\t\t\t\tisEmpty: true,\n\t\t\t\tchangeStored: true,\n\t\t\t\tblurRange: null\n\t\t\t}\n\t\t},\n\t\tmethods: {\n\t\t\tonPaste(e) {\n\t\t\t\tthis.isEmpty = false;\n\t\t\t\tlet txt = e.clipboardData.getData('Text')\n\t\t\t\tlet range = window.getSelection().getRangeAt(0)\n\t\t\t\tif (range.startContainer !== range.endContainer || range.startOffset !== range.endOffset) {\n\t\t\t\t\trange.deleteContents();\n\t\t\t\t}\n\t\t\t\t// 粘贴图片和文件时，这里没有数据\n\t\t\t\tif (txt && typeof(txt) == 'string') {\n\t\t\t\t\tlet textNode = document.createTextNode(txt);\n\t\t\t\t\trange.insertNode(textNode)\n\t\t\t\t\trange.collapse();\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\tlet items = (e.clipboardData || window.clipboardData).items\n\t\t\t\tif (items.length) {\n\t\t\t\t\tfor (let i = 0; i < items.length; i++) {\n\t\t\t\t\t\tif (items[i].type.indexOf('image') !== -1) {\n\t\t\t\t\t\t\tlet file = items[i].getAsFile();\n\t\t\t\t\t\t\tlet imagePush = {\n\t\t\t\t\t\t\t\tfileId: this.generateId(),\n\t\t\t\t\t\t\t\tfile: file,\n\t\t\t\t\t\t\t\turl: URL.createObjectURL(file)\n\t\t\t\t\t\t\t};\n\t\t\t\t\t\t\tthis.imageList[imagePush.fileId] = (imagePush);\n\t\t\t\t\t\t\tlet line = this.newLine();\n\t\t\t\t\t\t\tlet imageElement = document.createElement('img');\n\t\t\t\t\t\t\timageElement.className = 'chat-image no-text';\n\t\t\t\t\t\t\timageElement.src = imagePush.url;\n\t\t\t\t\t\t\timageElement.dataset.imgId = imagePush.fileId;\n\t\t\t\t\t\t\tline.appendChild(imageElement);\n\t\t\t\t\t\t\tlet after = document.createTextNode('\\u00A0');\n\t\t\t\t\t\t\tline.appendChild(after);\n\t\t\t\t\t\t\tthis.selectElement(after, 1);\t\t\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tlet asFile = items[i].getAsFile();\n\t\t\t\t\t\t\tif (!asFile) {\n\t\t\t\t\t\t\t\tcontinue;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tlet filePush = { fileId: this.generateId(), file: asFile };\n\t\t\t\t\t\t\tthis.fileList[filePush.fileId] = (filePush)\n\t\t\t\t\t\t\tlet line = this.newLine();\n\t\t\t\t\t\t\tlet fileElement = this.createFile(filePush);\n\t\t\t\t\t\t\tline.appendChild(fileElement);\n\t\t\t\t\t\t\tlet after = document.createTextNode('\\u00A0');\n\t\t\t\t\t\t\tline.appendChild(after);\n\t\t\t\t\t\t\tthis.selectElement(after, 1);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\trange.collapse();\n\t\t\t},\n\t\t\tselectElement(element, endOffset) {\n\t\t\t\tlet selection = window.getSelection();\n\t\t\t\t// 插入元素可能不是立即执行的，vue可能会在插入元素后再更新dom\n\t\t\t\tthis.$nextTick(() => {\n\t\t\t\t\tlet t1 = document.createRange();\n\t\t\t\t\tt1.setStart(element, 0);\n\t\t\t\t\tt1.setEnd(element, endOffset || 0);\n\t\t\t\t\tif (element.firstChild) {\n\t\t\t\t\t\tt1.selectNodeContents(element.firstChild);\n\t\t\t\t\t}\n\t\t\t\t\tt1.collapse();\n\t\t\t\t\tselection.removeAllRanges();\n\t\t\t\t\tselection.addRange(t1);\n\t\t\t\t\t// 需要时自动聚焦\n\t\t\t\t\tif (element.focus) {\n\t\t\t\t\t\telement.focus();\n\t\t\t\t\t}\n\t\t\t\t})\n\t\t\t},\n\t\t\tonCompositionEnd(e) {\n\t\t\t\tthis.compositionFlag = false;\n\t\t\t\tthis.onEditorInput(e);\n\t\t\t},\n\t\t\tonKeydown(e) {\n\t\t\t\tif (e.keyCode === 13) {\n\t\t\t\t\te.preventDefault();\n\t\t\t\t\te.stopPropagation();\n\t\t\t\t\tif (this.atIng) {\n\t\t\t\t\t\tconsole.log('选中at的人')\n\t\t\t\t\t\tthis.$refs.atBox.select();\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\t\t\t\t\tif (e.ctrlKey) {\n\t\t\t\t\t\tlet line = this.newLine();\n\t\t\t\t\t\tlet after = document.createTextNode('\\u00A0');\n\t\t\t\t\t\tline.appendChild(after);\n\t\t\t\t\t\tthis.selectElement(line.childNodes[0], 0);\n\t\t\t\t\t} else {\n\t\t\t\t\t\t// 中文输入标记\n\t\t\t\t\t\tif (this.compositionFlag) {\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\t\t\t\t\t\tthis.submit();\n\t\t\t\t\t}\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\t// 删除键\n\t\t\t\tif (e.keyCode === 8) {\n\t\t\t\t\tconsole.log(\"delete\")\n\t\t\t\t\t// 等待dom更新\n\t\t\t\t\tsetTimeout(() => {\n\t\t\t\t\t\tlet s = this.$refs.content.innerHTML.trim();\n\t\t\t\t\t\t// 空dom时，需要刷新dom\n\t\t\t\t\t\tconsole.log(s);\n\t\t\t\t\t\tif (s === '' || s === '<br>' || s === '<div>&nbsp;</div>' ) {\n\t\t\t\t\t\t\t// 拼接随机长度的空格，以刷新dom\n\t\t\t\t\t\t\tthis.empty();\n\t\t\t\t\t\t\tthis.isEmpty = true;\n\t\t\t\t\t\t\tthis.selectElement(this.$refs.content);\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tthis.isEmpty = false;\n\t\t\t\t\t\t}\n\t\t\t\t\t})\n\t\t\t\t}\n\t\t\t\t// at框打开时，上下键移动特殊处理\n\t\t\t\tif (this.atIng) {\n\t\t\t\t\tif (e.keyCode === 38) {\n\t\t\t\t\t\te.preventDefault();\n\t\t\t\t\t\te.stopPropagation();\n\t\t\t\t\t\tthis.$refs.atBox.moveUp();\n\t\t\t\t\t}\n\t\t\t\t\tif (e.keyCode === 40) {\n\t\t\t\t\t\te.preventDefault();\n\t\t\t\t\t\te.stopPropagation();\n\t\t\t\t\t\tthis.$refs.atBox.moveDown();\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t},\n\t\t\tonAtSelect(member) {\n\t\t\t\tthis.atIng = false;\n\t\t\t\t// 选中输入的 @xx 符\n\t\t\t\tlet blurRange = this.blurRange;\n\t\t\t\tlet endContainer = blurRange.endContainer\n\t\t\t\tlet startOffset = endContainer.data.indexOf(\"@\"+this.atSearchText);\n\t\t\t\tlet endOffset = startOffset + this.atSearchText.length + 1;\n\t\t\t\tblurRange.setStart(blurRange.endContainer, startOffset);\n\t\t\t\tblurRange.setEnd(blurRange.endContainer,  endOffset);\n\t\t\t\tblurRange.deleteContents()\n\t\t\t\tblurRange.collapse();\n\t\t\t\tconsole.log(\"onAtSelect\")\n\t\t\t\tthis.focus();\n\t\t\t\t// 创建元素节点\n\t\t\t\tlet element = document.createElement('SPAN')\n\t\t\t\telement.className = \"chat-at-user\";\n\t\t\t\telement.dataset.id = member.userId;\n\t\t\t\telement.contentEditable = 'false'\n\t\t\t\telement.innerText = `@${member.showNickName}`\n\t\t\t\tblurRange.insertNode(element)\n\t\t\t\t// 光标移动到末尾\n\t\t\t\tblurRange.collapse()\n\n\t\t\t\t// 插入空格\n\t\t\t\tlet textNode = document.createTextNode('\\u00A0');\n\t\t\t\tblurRange.insertNode(textNode);\n\n\t\t\t\tblurRange.collapse()\n\t\t\t\tthis.atSearchText = \"\";\n\t\t\t\tthis.selectElement(textNode, 1);\n\t\t\t},\n\t\t\tonEditorInput(e) {\n\t\t\t\tthis.isEmpty = false;\n\t\t\t\tthis.changeStored = false;\n\t\t\t\tif (this.$props.groupMembers && !this.compositionFlag) {\n\t\t\t\t\tlet selection = window.getSelection()\n\t\t\t\t\tlet range = selection.getRangeAt(0);\n\t\t\t\t\t// 截取@后面的名称作为过滤条件，并以空格结束\n\t\t\t\t\tlet endContainer = range.endContainer;\n\t\t\t\t\tlet endOffset = range.endOffset;\n\t\t\t\t\tlet textContent = endContainer.textContent;\n\t\t\t\t\tlet startIndex = -1;\n\t\t\t\t\tfor (let i = endOffset; i >= 0; i--) {\n\t\t\t\t\t\tif (textContent[i] === '@') {\n\t\t\t\t\t\t\tstartIndex = i;\n\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\t// 没有at符号，则关闭弹窗\n\t\t\t\t\tif (startIndex === -1) {\n\t\t\t\t\t\tthis.$refs.atBox.close();\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tlet endIndex = endOffset;\n\t\t\t\t\tfor (let i = endOffset; i < textContent.length; i++) {\n\t\t\t\t\t\tif (textContent[i] === ' ') {\n\t\t\t\t\t\t\tendIndex = i;\n\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\tthis.atSearchText = textContent.substring(startIndex + 1, endIndex).trim();\n\t\t\t\t\t// 打开选择弹窗\n\t\t\t\t\tif (this.atSearchText == '') {\n\t\t\t\t\t\tthis.showAtBox(e)\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t},\n\t\t\tonBlur(e) {\n\t\t\t\tthis.updateRange();\n\t\t\t\t\n\t\t\t},\n\t\t\tonMousedown() {\n\t\t\t\tif (this.atIng) {\n\t\t\t\t\tthis.$refs.atBox.close();\n\t\t\t\t\tthis.atIng = false;\n\t\t\t\t}\n\t\t\t},\n\t\t\tinsertEmoji(emojiText) {\n\t\t\t\tlet emojiElement = document.createElement('img');\n\t\t\t\temojiElement.className = 'chat-emoji no-text';\n\t\t\t\temojiElement.dataset.emojiCode = emojiText;\n\t\t\t\temojiElement.src = this.$emo.textToUrl(emojiText);\n\n\t\t\t\tlet blurRange = this.blurRange;\n\t\t\t\tif (!blurRange) {\n\t\t\t\t\tthis.focus();\n\t\t\t\t\tthis.updateRange();\n\t\t\t\t\tblurRange = this.blurRange;\n\t\t\t\t}\n\t\t\t\tif (blurRange.startContainer !== blurRange.endContainer || blurRange.startOffset !== blurRange.endOffset) {\n\t\t\t\t\tblurRange.deleteContents();\n\t\t\t\t}\n\t\t\t\tblurRange.insertNode(emojiElement);\n\t\t\t\tblurRange.collapse()\n\n\t\t\t\tlet textNode = document.createTextNode('\\u00A0');\n\t\t\t\tblurRange.insertNode(textNode)\n\t\t\t\tblurRange.collapse()\n\n\t\t\t\tthis.selectElement(textNode);\n\t\t\t\tthis.updateRange();\n\t\t\t\tthis.isEmpty = false;\n\t\t\t},\n\t\t\tgenerateId() {\n\t\t\t\treturn this.currentId++;\n\t\t\t},\n\t\t\tcreateFile(filePush) {\n\t\t\t\tlet file = filePush.file;\n\t\t\t\tlet fileId = filePush.fileId;\n\t\t\t\tlet container = document.createElement('div');\n\t\t\t\tcontainer.className = 'chat-file-container no-text';\n\t\t\t\tcontainer.contentEditable = 'false';\n\t\t\t\tcontainer.dataset.fileId = fileId;\n\n\t\t\t\tlet left = document.createElement('div');\n\t\t\t\tleft.className = 'file-position-left';\n\t\t\t\tcontainer.appendChild(left);\n\n\t\t\t\tlet icon = document.createElement('div');\n\t\t\t\ticon.className = 'el-icon-document';\n\t\t\t\tleft.appendChild(icon);\n\n\t\t\t\tlet right = document.createElement('div');\n\t\t\t\tright.className = 'file-position-right';\n\t\t\t\tcontainer.appendChild(right);\n\n\t\t\t\tlet fileName = document.createElement('div');\n\t\t\t\tfileName.className = 'file-name';\n\t\t\t\tfileName.innerText = file.name;\n\n\t\t\t\tlet fileSize = document.createElement('div');\n\t\t\t\tfileSize.className = 'file-size';\n\t\t\t\tfileSize.innerText = this.sizeConvert(file.size);\n\n\t\t\t\tright.appendChild(fileName);\n\t\t\t\tright.appendChild(fileSize);\n\n\t\t\t\treturn container;\n\t\t\t},\n\t\t\tsizeConvert(len) {\n\t\t\t\tif (len < 1024) {\n\t\t\t\t\treturn len + 'B';\n\t\t\t\t} else if (len < 1024 * 1024) {\n\t\t\t\t\treturn (len / 1024).toFixed(2) + 'KB';\n\t\t\t\t} else if (len < 1024 * 1024 * 1024) {\n\t\t\t\t\treturn (len / 1024 / 1024).toFixed(2) + 'MB';\n\t\t\t\t} else {\n\t\t\t\t\treturn (len / 1024 / 1024 / 1024).toFixed(2) + 'GB';\n\t\t\t\t}\n\t\t\t},\n\t\t\tupdateRange() {\n\t\t\t\tlet selection = window.getSelection();\n\t\t\t\tthis.blurRange = selection.getRangeAt(0);\n\t\t\t},\n\t\t\tnewLine() {\n\t\t\t\tlet selection = window.getSelection();\n\t\t\t\tlet range = selection.getRangeAt(0);\n\t\t\t\tlet divElement = document.createElement('div');\n\t\t\t\tlet endContainer = range.endContainer;\n\t\t\t\tlet parentElement = endContainer.parentElement;\n\t\t\t\tif (parentElement.parentElement === this.$refs.content) {\n\t\t\t\t\tdivElement.innerHTML  = endContainer.textContent.substring(range.endOffset).trim(); \n\t\t\t\t\tendContainer.textContent = endContainer.textContent.substring(0, range.endOffset);\n\t\t\t\t\t// 插入到当前div（当前行）后面\n\t\t\t\t\tparentElement.insertAdjacentElement('afterend', divElement);\n\t\t\t\t} else {\n\t\t\t\t\tdivElement.innerHTML = '';\n\t\t\t\t\tthis.$refs.content.append(divElement);\n\t\t\t\t}\n\t\t\t\treturn divElement;\n\t\t\t},\n\t\t\tclear() {\n\t\t\t\tthis.empty();\n\t\t\t\tthis.imageList = [];\n\t\t\t\tthis.fileList = [];\n\t\t\t},\n\t\t\tempty() {\n\t\t\t\tthis.$refs.content.innerHTML = \"\";\n\t\t\t\tlet line = this.newLine();\n\t\t\t\tlet after = document.createTextNode('\\u00A0');\n\t\t\t\tline.appendChild(after);\n\t\t\t\tthis.$nextTick(()=>this.selectElement(after));\n\t\t\t},\n\t\t\tshowAtBox(e) {\n\t\t\t\tthis.atIng = true;\n\t\t\t\t// show之后会自动更新当前搜索的text\n\t\t\t\t// this.atSearchText = \"\";\n\t\t\t\tlet selection = window.getSelection()\n\t\t\t\tlet range = selection.getRangeAt(0)\n\t\t\t\t// 光标所在坐标\n\t\t\t\tlet pos = range.getBoundingClientRect();\n\t\t\t\tthis.$refs.atBox.open({\n\t\t\t\t\tx: pos.x,\n\t\t\t\t\ty: pos.y\n\t\t\t\t})\n\t\t\t\t// 记录光标所在位置\n\t\t\t\tthis.updateRange();\n\t\t\t},\n\t\t\thtml2Escape(strHtml) {\n\t\t\t\treturn strHtml.replace(/[<>&\"]/g, function(c) {\n\t\t\t\t\treturn {\n\t\t\t\t\t\t'<': '&lt;',\n\t\t\t\t\t\t'>': '&gt;',\n\t\t\t\t\t\t'&': '&amp;',\n\t\t\t\t\t\t'\"': '&quot;'\n\t\t\t\t\t} [c];\n\t\t\t\t});\n\t\t\t},\n\t\t\tsubmit() {\n\t\t\t\tlet nodes = this.$refs.content.childNodes;\n\t\t\t\tlet fullList = [];\n\t\t\t\tlet tempText = '';\n\t\t\t\tlet atUserIds = [];\n\t\t\t\tlet each = (nodes) => {\n\t\t\t\t\tfor (let i = 0; i < nodes.length; i++) {\n\t\t\t\t\t\tlet node = nodes[i];\n\t\t\t\t\t\tif (!node) {\n\t\t\t\t\t\t\tcontinue;\n\t\t\t\t\t\t}\n\t\t\t\t\t\tif (node.nodeType === 3) {\n\t\t\t\t\t\t\ttempText += this.html2Escape(node.textContent);\n\t\t\t\t\t\t\tcontinue;\n\t\t\t\t\t\t}\n\t\t\t\t\t\tlet nodeName = node.nodeName.toLowerCase();\n\t\t\t\t\t\tif (nodeName === 'script') {\n\t\t\t\t\t\t\tcontinue;\n\t\t\t\t\t\t}\n\t\t\t\t\t\tlet text = tempText.trim();\n\t\t\t\t\t\tif (nodeName === 'img') {\n\t\t\t\t\t\t\tlet imgId = node.dataset.imgId;\n\t\t\t\t\t\t\tif (imgId) {\n\t\t\t\t\t\t\t\tif (text) {\n\t\t\t\t\t\t\t\t\tfullList.push({\n\t\t\t\t\t\t\t\t\t\ttype: 'text',\n\t\t\t\t\t\t\t\t\t\tcontent: text,\n\t\t\t\t\t\t\t\t\t\tatUserIds: atUserIds\n\t\t\t\t\t\t\t\t\t})\n\t\t\t\t\t\t\t\t\ttempText = '';\n\t\t\t\t\t\t\t\t\tatUserIds = []\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tfullList.push({\n\t\t\t\t\t\t\t\t\ttype: 'image',\n\t\t\t\t\t\t\t\t\tcontent: this.imageList[imgId]\n\t\t\t\t\t\t\t\t})\n\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\tlet emojiCode = node.dataset.emojiCode;\n\t\t\t\t\t\t\t\ttempText += emojiCode;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t} else if (nodeName === 'div') {\n\t\t\t\t\t\t\tlet fileId = node.dataset.fileId\n\t\t\t\t\t\t\t// 文件\n\t\t\t\t\t\t\tif (fileId) {\n\t\t\t\t\t\t\t\tif (text) {\n\t\t\t\t\t\t\t\t\tfullList.push({\n\t\t\t\t\t\t\t\t\t\ttype: 'text',\n\t\t\t\t\t\t\t\t\t\tcontent: text,\n\t\t\t\t\t\t\t\t\t\tatUserIds: atUserIds\n\t\t\t\t\t\t\t\t\t})\n\t\t\t\t\t\t\t\t\ttempText = '';\n\t\t\t\t\t\t\t\t\tatUserIds = []\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tfullList.push({\n\t\t\t\t\t\t\t\t\ttype: 'file',\n\t\t\t\t\t\t\t\t\tcontent: this.fileList[fileId]\n\t\t\t\t\t\t\t\t})\n\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\ttempText += '\\n';\n\t\t\t\t\t\t\t\teach(node.childNodes);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t} else if (nodeName === 'span') {\n\t\t\t\t\t\t\tif(node.dataset.id){\n\t\t\t\t\t\t\t\ttempText += node.innerHTML;\n\t\t\t\t\t\t\t\tatUserIds.push(node.dataset.id)\n\t\t\t\t\t\t\t}else {\n\t\t\t\t\t\t\t\ttempText += node.outerHtml;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\teach(nodes)\n\t\t\t\tlet text = tempText.trim();\n\t\t\t\tif (text !== '') {\n\t\t\t\t\tfullList.push({\n\t\t\t\t\t\ttype: 'text',\n\t\t\t\t\t\tcontent: text,\n\t\t\t\t\t\tatUserIds: atUserIds\n\t\t\t\t\t})\n\t\t\t\t}\n\t\t\t\tthis.$emit('submit', fullList);\n\t\t\t},\n\t\t\tfocus() {\n\t\t\t\tthis.$refs.content.focus();\n\t\t\t}\n\n\t\t}\n\t}\n</script>\n\n<style lang=\"scss\">\n\t.chat-input-area {\n\t\twidth: 100%;\n\t\theight: 100%;\n\t\tposition: relative;\n\n\t\t.edit-chat-container {\n\t\t\tposition: absolute;\n\t\t\ttop: 0;\n\t\t\tleft: 0;\n\t\t\tright: 0;\n\t\t\tbottom: 0;\n\t\t\tborder: 1px solid #c3c3c3;\n\t\t\toutline: none;\n\t\t\tpadding: 5px;\n\t\t\tline-height: 30px;\n\t\t\tfont-size: 16px;\n\t\t\ttext-align: left;\n\t\t\toverflow-y: scroll;\n\n\t\t\t// 单独一行时，无法在前面输入的bug\n\t\t\t>div:before {\n\t\t\t\tcontent: \"\\00a0\";\n\t\t\t\tfont-size: 14px;\n\t\t\t\tposition: absolute;\n\t\t\t\ttop: 0;\n\t\t\t\tleft: 0;\n\t\t\t}\n\n\t\t\t.chat-image {\n\t\t\t\tdisplay: block;\n\t\t\t\tmax-width: 200px;\n\t\t\t\tmax-height: 100px;\n\t\t\t\tborder: 1px solid #e6e6e6;\n\t\t\t\tcursor: pointer;\n\t\t\t}\n\n\t\t\t.chat-emoji {\n\t\t\t\twidth: 30px;\n\t\t\t\theight: 30px;\n\t\t\t\tvertical-align: top;\n\t\t\t\tcursor: pointer;\n\t\t\t}\n\n\t\t\t.chat-file-container {\n\t\t\t\tmax-width: 65%;\n\t\t\t\tpadding: 10px;\n\t\t\t\tborder: 2px solid #587ff0;\n\t\t\t\tdisplay: flex;\n\t\t\t\tbackground: #eeeC;\n\t\t\t\tborder-radius: 10px;\n\n\t\t\t\t.file-position-left {\n\t\t\t\t\tdisplay: flex;\n\t\t\t\t\twidth: 80px;\n\t\t\t\t\tjustify-content: center;\n\t\t\t\t\talign-items: center;\n\n\t\t\t\t\t.el-icon-document {\n\t\t\t\t\t\tfont-size: 40px;\n\t\t\t\t\t\ttext-align: center;\n\t\t\t\t\t\tcolor: #d42e07;\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\t.file-position-right {\n\t\t\t\t\tflex: 1;\n\n\t\t\t\t\t.file-name {\n\t\t\t\t\t\tfont-size: 16px;\n\t\t\t\t\t\tfont-weight: 600;\n\t\t\t\t\t\tcolor: #66b1ff;\n\t\t\t\t\t}\n\n\t\t\t\t\t.file-size {\n\t\t\t\t\t\tfont-size: 14px;\n\t\t\t\t\t\tfont-weight: 600;\n\t\t\t\t\t\tcolor: black;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t.chat-at-user {\n\t\t\t\tcolor: #00f;\n\t\t\t\tfont-weight: 600;\n\n\t\t\t\tborder-radius: 3px;\n\t\t\t}\n\t\t}\n\n\t\t.edit-chat-container>div:nth-of-type(1):after {\n\t\t\tcontent: '请输入消息（按Ctrl+Enter键换行）';\n\t\t\tcolor: gray;\n\t\t}\n\n\t\t.edit-chat-container.not-empty>div:nth-of-type(1):after {\n\t\t\tcontent: none;\n\t\t}\n\n\t}\n</style>"]}]}